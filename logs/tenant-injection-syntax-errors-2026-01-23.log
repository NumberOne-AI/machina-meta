# Tenant Injection Syntax Errors - Evidence Log
# Collected from tusdi-preview-92 namespace on 2026-01-23
# Pod: tusdi-api-79d94cc9d4-9drzv

## Summary

The `TenantInjector` (via `WhereClauseBuilder`) incorrectly injects `patient_id`
filter conditions in the **middle** of multi-word Cypher operators like `STARTS WITH`,
causing syntax errors.

## Error Pattern

**Original Cypher (generated by CypherAgent):**
```cypher
MATCH (ov:ObservationValueNode)-[:INSTANCE_OF]->(ot:ObservationTypeNode)
WHERE toLower(ot.summary) STARTS WITH "t" AND ov.value_number > 2
WITH ov, ot
OPTIONAL MATCH (ot)-[:HAS_RANGE]->(rr:ReferenceRangeNode)
RETURN ov, ot, rr
LIMIT 100
```

**After tenant injection (BROKEN):**
```cypher
MATCH (ov:ObservationValueNode)-[:INSTANCE_OF]->(ot:ObservationTypeNode)
WHERE (toLower(ot.summary) STARTS) AND ov.patient_id = $patient_id WITH "t" AND ov.value_number > 2
WITH ov, ot
OPTIONAL MATCH (ot)-[:HAS_RANGE]->(rr:ReferenceRangeNode)
RETURN ov, ot, rr
LIMIT 100
```

**Error:**
```
Neo.ClientError.Statement.SyntaxError
Invalid input ')': expected 'WITH' (line 1, column 107 (offset: 106))
```

## Root Cause Analysis

The `WhereClauseBuilder._find_where_clause_end()` method (lines 149-190 in
`where_clause_builder.py`) attempts to detect clause boundaries but has a bug:

1. It searches for `WITH` keyword to find WHERE clause end
2. When CypherAgent generates `STARTS WITH`, the injector finds `WITH` at column 107
3. It incorrectly interprets this as a new WITH clause (not part of STARTS WITH)
4. The detection code on lines 174-179 attempts to look backwards for STARTS/ENDS:
   ```python
   if keyword == CLAUSE_WITH:
       before = self._query[max(0, match.start() - 10) : match.start()]
       if re.search(r"\b(STARTS|ENDS)\s*$", before, re.IGNORECASE):
           pos = match.end()
           continue
   ```
5. But this check may fail due to intervening content or whitespace

## Evidence from agent-trace.log

### Instance 1 (2026-01-23T03:40:31)
```
event_type="tool_completed" tool_name="query_graph" agent="HealthConsultantAgent"
function_call_id="adk-6badb400-27a3-451f-95cb-45550004d094"
arguments={'natural_language_query': "Find all observations where the name starts with 'T' and the value is greater than 2", 'is_complex': True}
result="{'error': 'Query execution failed', 'details': 'Query execution failed: {code: Neo.ClientError.Statement.SyntaxError} {message: Invalid input ')': expected 'WITH' (line 1, column 107 (offset: 106))"
```

### Instance 2 (2026-01-23T03:40:49)
```
event_type="tool_completed" tool_name="query_graph" agent="HealthConsultantAgent"
function_call_id="adk-557ba121-90dc-4ba1-b97a-365ce1933bed"
arguments={'is_complex': True, 'natural_language_query': "Find all observations where the name starts with 'T'"}
result="{'error': 'Query execution failed', 'details': 'Query execution failed: {code: Neo.ClientError.Statement.SyntaxError} {message: Invalid input ')': expected 'WITH'"
```

### Full broken query from logs:
```
"MATCH (ov:ObservationValueNode)-[:INSTANCE_OF]->(ot:ObservationTypeNode) WHERE (toLower(ot.summary) STARTS) AND ov.patient_id = $patient_id WITH "t" AND ov.value_number > 2 WITH ov, ot OPTIONAL MATCH (ot)-[:HAS_RANGE]->(rr:ReferenceRangeNode) RETURN ov, ot, rr LIMIT 100"
```

Note how `STARTS WITH "t"` became `STARTS) AND ov.patient_id = $patient_id WITH "t"`

## Impact

- Any query using `STARTS WITH`, `ENDS WITH`, or potentially `CONTAINS` patterns
  will have syntax errors after tenant injection
- This breaks natural language queries like "find observations starting with..."
- The agent sees repeated failures and cannot recover

## Files Involved

- `repos/dem2/shared/src/machina/shared/graph_traversal/tenant_injector.py` - Main injector
- `repos/dem2/shared/src/machina/shared/graph_traversal/where_clause_builder.py` - Bug location (lines 149-190)
- `repos/dem2/services/medical-agent/src/machina/medical_agent/agents/CypherAgent/config.yml` - Agent instructions mentioning tenant scoping
