# GCloud Admin Container - Common Operations
# Usage: just <command>

set dotenv-load := true

# Default: show help
default:
    @just --list

# Build the gcloud-admin container
build:
    docker compose build

# Build with no cache
build-fresh:
    docker compose build --no-cache

# Start interactive shell in gcloud-admin container
shell:
    docker compose run --rm gcloud-admin

# Start container in background
up:
    docker compose up -d

# Stop background container
down:
    docker compose down

# Show container logs
logs:
    docker compose logs -f

# Check authentication status for all services
auth-status:
    @echo "=== Authentication Status ==="
    @echo ""
    @echo ">>> Google Cloud:"
    @just auth-gcloud-status || true
    @echo ""
    @echo ">>> Kubernetes (GKE):"
    @just auth-gke-status || true
    @echo ""
    @echo ">>> GitHub:"
    @just auth-github-status || true
    @echo ""
    @echo ">>> ArgoCD:"
    @just auth-argocd-status || true
    @echo ""
    @echo "To authenticate all services, run: just auth-login"

# Check Google Cloud authentication status
auth-gcloud-status:
    @docker compose run --rm gcloud-admin gcloud auth list
    @echo ""
    @docker compose run --rm gcloud-admin gcloud config list

# Check Kubernetes (GKE) connection status
auth-gke-status:
    @docker compose run --rm gcloud-admin kubectl cluster-info 2>&1 | head -1 || echo "  Cannot connect to cluster"
    @echo "Current context:"
    @docker compose run --rm gcloud-admin kubectl config current-context

# Check GitHub authentication status
auth-github-status:
    #!/usr/bin/env bash
    set +e
    OUTPUT=$(docker compose run --rm gcloud-admin gh auth status 2>&1)
    STATUS=$?
    # Filter out the "gh auth login" recommendation and display the rest
    echo "$OUTPUT" | sed '/gh auth login/d'
    if [ $STATUS -ne 0 ]; then
        echo ""
        echo "To authenticate GitHub, run one of:"
        echo "  just auth-login                # Complete authentication (recommended)"
        echo "  just auth-github-import        # Import token from host gh CLI"
        echo "  just auth-github-login         # Login directly in container"
    fi
    exit $STATUS

# Check ArgoCD authentication status
auth-argocd-status:
    #!/usr/bin/env bash
    set +e
    OUTPUT=$(docker compose run --rm gcloud-admin argocd account get-user-info 2>&1)
    STATUS=$?
    echo "$OUTPUT"
    if [ $STATUS -ne 0 ]; then
        echo ""
        echo "To authenticate ArgoCD:"
        echo "  Linux:  just auth-argocd-login"
        echo "  macOS:  just auth-argocd-import  (auth on host first)"
    fi
    exit $STATUS

# Complete authentication setup: GCloud + GKE + GitHub + ArgoCD
auth-login:
    @echo "=== Step 1: Authenticating with Google Cloud ==="
    docker compose run --rm gcloud-admin gcloud auth login --update-adc
    @echo ""
    @echo "=== Step 2: Getting GKE cluster credentials (nonprod) ==="
    docker compose run --rm gcloud-admin gcloud container clusters get-credentials tusdi-nonprod-cluster --region us-central1
    @echo ""
    @echo "=== Step 3: Importing GitHub credentials from host ==="
    @just auth-github-import
    @echo ""
    @echo "=== Step 4: Authenticating with ArgoCD (SSO) ==="
    @just auth-argocd-login
    @echo ""
    @echo "=== Authentication complete! ==="
    @echo "Verify with: just auth-status"

# Logout from all services: GCloud + GitHub + ArgoCD
auth-logout:
    @echo "=== Logging out from all services ==="
    @echo ""
    @echo ">>> Google Cloud:"
    @just auth-gcloud-logout || true
    @echo ""
    @echo ">>> GitHub:"
    @just auth-github-logout || true
    @echo ""
    @echo ">>> ArgoCD:"
    @just auth-argocd-logout || true
    @echo ""
    @echo "=== Logout complete! ==="

# Authenticate with Google Cloud only
auth-gcloud-login:
    docker compose run --rm gcloud-admin gcloud auth login --update-adc

# Revoke Google Cloud authentication (including Application Default Credentials)
auth-gcloud-logout:
    docker compose run --rm gcloud-admin gcloud auth application-default revoke --quiet
    docker compose run --rm gcloud-admin gcloud auth revoke

# Complete first-time setup: auth + get nonprod credentials + verify
setup-nonprod:
    @echo "=== Step 1: Authenticating with Google Cloud ==="
    docker compose run --rm gcloud-admin gcloud auth login --update-adc
    @echo ""
    @echo "=== Step 2: Getting GKE cluster credentials ==="
    docker compose run --rm gcloud-admin gcloud container clusters get-credentials tusdi-nonprod-cluster --region us-central1
    @echo ""
    @echo "=== Step 3: Verifying connection ==="
    docker compose run --rm gcloud-admin kubectl cluster-info
    @echo ""
    @echo "=== Setup complete! ==="
    @echo "You can now run: just kubectl get nodes"

# Complete first-time setup: auth + get prod credentials + verify
setup-prod:
    @echo "=== Step 1: Authenticating with Google Cloud ==="
    docker compose run --rm gcloud-admin gcloud auth login --update-adc
    @echo ""
    @echo "=== Step 2: Getting GKE cluster credentials ==="
    docker compose run --rm gcloud-admin gcloud container clusters get-credentials tusdi-prod-cluster --region us-central1
    @echo ""
    @echo "=== Step 3: Verifying connection ==="
    docker compose run --rm gcloud-admin kubectl cluster-info
    @echo ""
    @echo "=== Setup complete! ==="
    @echo "You can now run: just kubectl get nodes"

# Get GKE credentials for nonprod cluster
get-creds-nonprod:
    docker compose run --rm gcloud-admin gcloud container clusters get-credentials tusdi-nonprod-cluster --region us-central1

# Get GKE credentials for prod cluster
get-creds-prod:
    docker compose run --rm gcloud-admin gcloud container clusters get-credentials tusdi-prod-cluster --region us-central1

# Export nonprod GKE credentials to host kubectl config and make it current
export-creds-nonprod:
    ./scripts/export-kube-config.sh gke_n1-machina1_us-central1_tusdi-nonprod-cluster

# Export prod GKE credentials to host kubectl config and make it current
export-creds-prod:
    ./scripts/export-kube-config.sh gke_n1-machina1_us-central1_tusdi-prod-cluster

# List all GKE clusters
list-clusters:
    docker compose run --rm gcloud-admin gcloud container clusters list

# Run kubectl command
kubectl *args:
    docker compose run --rm gcloud-admin kubectl {{ args }}

# Run helm command
helm *args:
    docker compose run --rm gcloud-admin helm {{ args }}

# Run k9s (interactive)
k9s:
    docker compose run --rm gcloud-admin k9s

# Run argocd CLI
argocd *args:
    docker compose run --rm gcloud-admin argocd {{ args }}

# Run arbitrary command in gcloud-admin container
run *args:
    docker compose run --rm gcloud-admin {{ args }}

# Show current context
context:
    docker compose run --rm gcloud-admin kubectl config current-context

# List all contexts
contexts:
    docker compose run --rm gcloud-admin kubectl config get-contexts

# Switch context
switch-context ctx:
    docker compose run --rm gcloud-admin kubectl config use-context {{ ctx }}

# Get all pods across namespaces
pods:
    docker compose run --rm gcloud-admin kubectl get pods -A

# Get all services
services:
    docker compose run --rm gcloud-admin kubectl get svc -A

# Get all deployments
deployments:
    docker compose run --rm gcloud-admin kubectl get deployments -A

# Tail logs for a pod pattern (e.g., just logs dem2 -n dev)
stern *args:
    docker compose run --rm gcloud-admin stern {{ args }}

# Network debug - DNS lookup
dig host:
    docker compose run --rm gcloud-admin dig {{ host }}

# Network debug - TCP connectivity check
nc host port:
    docker compose run --rm gcloud-admin nc -zv {{ host }} {{ port }}

# Network debug - traceroute
trace host:
    docker compose run --rm gcloud-admin traceroute {{ host }}

# Show resource usage across nodes
node-resources:
    docker compose run --rm gcloud-admin kubectl resource-capacity

# Show what permissions current user has
whoami:
    docker compose run --rm gcloud-admin kubectl whoami

# Import GitHub token from host's gh CLI (preferred method)
auth-github-import:
    #!/usr/bin/env bash
    set -euo pipefail
    if command -v gh &>/dev/null; then
        echo "Exporting token from host's gh CLI..."
        TOKEN=$(gh auth token 2>/dev/null || echo "")
        if [ -n "$TOKEN" ]; then
            echo "Importing token to container..."
            echo "$TOKEN" | docker compose run --rm -T gcloud-admin gh auth login --with-token
            echo "Done. Verify with: just auth-github-status"
        else
            echo "No valid token found on host"
            echo "Authenticate on host first: gh auth login"
        fi
    else
        echo "GitHub CLI not found on host"
        echo "Install gh or use 'just auth-github-login' to authenticate in container"
    fi

# Login to GitHub directly in container (prompts for token)
auth-github-login:
    docker compose run --rm gcloud-admin gh auth login

# Logout from GitHub
auth-github-logout:
    docker compose run --rm gcloud-admin gh auth logout

# Login to ArgoCD server (using SSO)
# NOTE: Uses --network host which works on Linux but NOT on macOS.
# On macOS, use: just auth-argocd-import (auth on host first, then import)
auth-argocd-login:
    docker run --rm -it --network host \
        -v gcloud-admin_argocd-config:/root/.config/argocd \
        -e ARGOCD_SERVER=${ARGOCD_SERVER} \
        gcloud-admin:latest \
        bash -c 'argocd login "$ARGOCD_SERVER" --sso --grpc-web --sso-launch-browser=false'

# Import ArgoCD credentials from host (macOS workaround)
# On macOS, --network host doesn't work for SSO callbacks.
# Workaround: authenticate on host, then import credentials to container.
# Prerequisites: argocd CLI installed on host (brew install argocd)
auth-argocd-import:
    #!/usr/bin/env bash
    set -euo pipefail
    HOST_ARGOCD_CONFIG="${HOME}/.config/argocd/config"

    if [ ! -f "$HOST_ARGOCD_CONFIG" ]; then
        echo "ArgoCD config not found at: $HOST_ARGOCD_CONFIG"
        echo ""
        echo "To authenticate on your host first:"
        echo "  1. Install argocd CLI: brew install argocd"
        echo "  2. Login: argocd login ${ARGOCD_SERVER:-<ARGOCD_SERVER>} --sso --grpc-web"
        echo "  3. Then run: just auth-argocd-import"
        exit 1
    fi

    echo "Found ArgoCD config at: $HOST_ARGOCD_CONFIG"
    echo "Importing to container volume..."

    # Copy config file to the Docker volume
    docker run --rm \
        -v "$HOST_ARGOCD_CONFIG:/tmp/argocd-config:ro" \
        -v gcloud-admin_argocd-config:/root/.config/argocd \
        alpine sh -c 'cp /tmp/argocd-config /root/.config/argocd/config && chmod 600 /root/.config/argocd/config'

    echo "Done. Verify with: just auth-argocd-status"

# Logout from ArgoCD server
auth-argocd-logout:
    docker compose run --rm gcloud-admin argocd logout "$ARGOCD_SERVER"

# Check ArgoCD app status
argo-status app:
    @just argocd app get {{ app }}

# Sync ArgoCD app
argo-sync app:
    @just argocd app sync {{ app }}

# List ArgoCD apps
argo-list:
    @just argocd app list

# Port forward to a service (e.g., just port-forward svc/argocd-server 8080:443 -n argocd)
port-forward *args:
    docker compose run --rm -p 8080:8080 gcloud-admin kubectl port-forward {{ args }}

# Show tool versions
versions:
    @echo "=== Tool Versions ==="
    docker compose run --rm gcloud-admin bash -c '\
        echo "gcloud: $(gcloud version 2>/dev/null | head -1)"; \
        echo "kubectl: $(kubectl version --client -o json 2>/dev/null | jq -r .clientVersion.gitVersion)"; \
        echo "helm: $(helm version --short 2>/dev/null)"; \
        echo "kustomize: $(kustomize version 2>/dev/null)"; \
        echo "k9s: $(k9s version --short 2>/dev/null | head -1)"; \
        echo "argocd: $(argocd version --client --short 2>/dev/null)"; \
        echo "stern: $(stern --version 2>/dev/null)"; \
    '

# Clean up dangling images
clean:
    docker image prune -f
    docker compose down --rmi local

# === Workspace Operations ===

# Show git status across all workspace repos
workspace-status:
    docker compose run --rm gcloud-admin bash -c 'for dir in /workspace/repos/*/; do echo ""; echo "=== $$$$(basename "$$$$dir") ==="; git -C "$$$$dir" status -sb; done'

# Show current branches across all workspace repos
workspace-branches:
    docker compose run --rm gcloud-admin bash -c 'for dir in /workspace/repos/*/; do printf "%-20s %s\n" "$$$$(basename "$$$$dir"):" "$$$$(git -C "$$$$dir" branch --show-current)"; done'

# Show recent commits across all workspace repos
workspace-log lines="5":
    docker compose run --rm gcloud-admin bash -c 'for dir in /workspace/repos/*/; do echo ""; echo "=== $$$$(basename "$$$$dir") ==="; git -C "$$$$dir" log --oneline -n {{ lines }}; done'

# === Preview Environment Management ===

# Show detailed information about a preview environment
preview-info *args:
    docker compose run --rm gcloud-admin python3 /workspace/scripts/preview-tool.py info {{ args }}

# Delete preview environment (remove tags and close PR to trigger ArgoCD cleanup)
preview-delete *args:
    docker compose run --rm gcloud-admin python3 /workspace/scripts/preview-tool.py delete {{ args }}

# Tag repository to create/update preview environment (auto-detects branch)
# Usage: just preview-tag <repo>
#   <repo>: Repository name under repos/ (dem2, dem2-webui, etc), or 'all' for all taggable repos
# Examples:
#   just preview-tag dem2          # Tags dem2 with current branch
#   just preview-tag dem2-webui    # Tags dem2-webui with current branch
#   just preview-tag all           # Tags all repos (excludes dem2-infra, medical-catalog)
preview-tag repo:
    docker compose run --rm gcloud-admin python3 /workspace/scripts/preview-tool.py tag {{ repo }}

# Create/update preview environment (tags all taggable repos)
# Shortcut for: just preview-tag all
preview:
    @just preview-tag all
