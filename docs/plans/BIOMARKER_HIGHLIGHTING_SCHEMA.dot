// Neo4j Schema for Biomarker Interval Matching
// Render: dot -Tsvg BIOMARKER_HIGHLIGHTING_SCHEMA.dot -o BIOMARKER_HIGHLIGHTING_SCHEMA.svg
digraph BiomarkerSchema {
    rankdir=TB;

    // Font settings and background
    graph [fontsize=14, fontname="Arial", bgcolor="#f5f5f5", style=filled];
    node [shape=box, style=filled, fontsize=12, fontname="Arial"];
    edge [fontsize=10, fontname="Arial"];

    // --- SCHEMA SECTION ---
    subgraph cluster_schema {
        label="Neo4j Schema Structure";
        fillcolor="#e8f4e8";
        style=filled;
        fontsize=14;

        ObservationType [label="ObservationTypeNode\n────────────────\nuuid\nname\ncode\nunit", fillcolor=lightgreen];
        ObservationValue [label="ObservationValueNode\n────────────────\nuuid\nvalue_numeric\nvalue_text\nobserved_at\nunit", fillcolor=lightyellow];
        ReferenceRange [label="ReferenceRangeNode\n────────────────\nuuid\nrange_type\nsource_type\nsource_id\nintervals_json (deprecated)", fillcolor=lightblue];
        RangeInterval [label="RangeIntervalNode (NEW)\n────────────────\nuuid\nlabel\ncategory\ncolor ← READ THIS\nlow / high\nlow_inclusive / high_inclusive\ntext", fillcolor=lightcyan];

        // Relationships
        ObservationType -> ObservationValue [label="HAS_VALUE\n(one-to-many)", style=bold];
        ObservationType -> ReferenceRange [label="HAS_RANGE\n(one-to-one)", style=bold];
        ReferenceRange -> RangeInterval [label="HAS_INTERVAL\n(one-to-many:\nrange owns ALL\npotential intervals)", style=bold, color=darkgreen];
        ObservationValue -> RangeInterval [label="MATCHES_INTERVAL\n(one-to-one:\nvalue links to\nMATCHED interval)", style=bold, color=blue];
    }

    // --- EXAMPLE SECTION ---
    subgraph cluster_example {
        label="Example: Total Cholesterol with values 163 (in-range) and 220 (out-of-range)";
        fillcolor="#f4f4e8";
        style=filled;
        fontsize=14;

        // Nodes
        CholesterolType [label="ObservationTypeNode\n\"Total Cholesterol\"\nunit: mg/dL", fillcolor=lightgreen];
        CholesterolRange [label="ReferenceRangeNode\nrange: \"<200\"", fillcolor=lightblue];

        // Values
        Value163 [label="ObservationValueNode\nvalue: 163 mg/dL\n✓ IN-RANGE", fillcolor="#90EE90"];  // Light green
        Value220 [label="ObservationValueNode\nvalue: 220 mg/dL\n✗ OUT-OF-RANGE", fillcolor="#FFB6C1"];  // Light pink/red

        // Intervals
        Interval1 [label="RangeIntervalNode #1\nlabel: \"<200\"\ncategory: Normal\ncolor: GREEN ✓", fillcolor="#32CD32", fontcolor=white];  // Lime green
        Interval2 [label="RangeIntervalNode #2\nlabel: \"≥200\" (synthetic)\ncategory: High\ncolor: RED ✗", fillcolor="#DC143C", fontcolor=white];  // Crimson

        // Type relationships
        CholesterolType -> Value163 [label="HAS_VALUE"];
        CholesterolType -> Value220 [label="HAS_VALUE"];
        CholesterolType -> CholesterolRange [label="HAS_RANGE"];

        // Range owns intervals
        CholesterolRange -> Interval1 [label="HAS_INTERVAL", color=darkgreen];
        CholesterolRange -> Interval2 [label="HAS_INTERVAL", color=darkgreen];

        // Values match to intervals (THE KEY RELATIONSHIPS)
        Value163 -> Interval1 [label="MATCHES_INTERVAL\n(163 < 200)", style=bold, color=blue, penwidth=2];
        Value220 -> Interval2 [label="MATCHES_INTERVAL\n(220 ≥ 200)", style=bold, color=blue, penwidth=2];
    }

    // Legend
    subgraph cluster_legend {
        label="Legend";
        fillcolor=white;
        style=filled;
        fontsize=12;

        legend [label="Relationships:\n• HAS_VALUE: Type owns its measurement values\n• HAS_RANGE: Type owns its reference range\n• HAS_INTERVAL: Range owns ALL potential intervals\n• MATCHES_INTERVAL: Value links to ONE matched interval\n\nColors indicate interval status:\n• GREEN: Normal/Optimal (in-range)\n• YELLOW: Borderline/Elevated\n• RED: High/Low/Abnormal (out-of-range)\n• WHITE: No reference range available", shape=note, fillcolor=white, fontsize=10];
    }
}
