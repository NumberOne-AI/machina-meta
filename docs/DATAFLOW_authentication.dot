// Diagram #4: Authentication Flow
// Google SSO authentication and JWT token management

digraph Authentication {
    rankdir=LR;
    graph [fontsize=14, fontname="Arial", bgcolor="#f5f5f5", style=filled];
    node [shape=box, style=filled, fontsize=12, fontname="Arial"];
    edge [fontsize=10, fontname="Arial"];

    // Standard entities
    Browser [label="Web Browser", fillcolor=lightblue];
    NextJS [label="Next.js Frontend\nPort 3000", fillcolor=lightyellow];
    FastAPI [label="FastAPI Backend\nPort 8000", fillcolor=lightgreen];
    Postgres [label="PostgreSQL\n5432", fillcolor=skyblue, shape=cylinder];
    GoogleOAuth [label="Google OAuth", fillcolor=plum];

    // Authentication flow
    Browser -> NextJS [label="Visit /login"];
    NextJS -> Browser [label="Redirect to Google", style=dashed];
    Browser -> GoogleOAuth [label="Google SSO"];
    GoogleOAuth -> Browser [label="ID Token", style=dashed];
    Browser -> NextJS [label="ID Token"];
    NextJS -> FastAPI [label="HTTP POST\n/api/v1/auth/google\nID Token"];
    FastAPI -> GoogleOAuth [label="Verify token"];
    GoogleOAuth -> FastAPI [label="Token valid", style=dashed];
    FastAPI -> Postgres [label="PostgreSQL\nSELECT/INSERT user"];
    Postgres -> FastAPI [label="User record", style=dashed];
    FastAPI -> NextJS [label="HTTP 200\nSet-Cookie: JWT\naccess + refresh", style=dashed];
    NextJS -> Browser [label="Redirect /dashboard", style=dashed];

    // Session polling
    Browser -> FastAPI [label="GET /api/v1/auth/session\n(every 60s)\nCookie: JWT", color=blue];
    FastAPI -> Browser [label="HTTP 200\nSession valid", style=dashed, color=blue];
}
